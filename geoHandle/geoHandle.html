<!DOCTYPE html>
<!--
やること

		fixedサイドバー
			dipslay none <>
			fixedで表示を切り替え
			またはホーバーで広がるサイドバー

		仮マーカーの実装　
			あらかじめ各町のlatlngを取得しておく
			要外部DBへの接続実装
-->


<html lang="ja">
<head>
	<title>地図プロット</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.18.1/build/cssreset/cssreset-min.css">
	<link rel="stylesheet" href="geoHandle.css" type="text/css">
	<script src="http://maps.google.com/maps/api/js?language=ja"></script>
	<script src="https://google-maps-utility-library-v3.googlecode.com/svn-history/r213/trunk/richmarker/src/richmarker-compiled.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="geoHandle.js"></script>
	<script src="./dataHandle.js"></script>
	<script src="../dataHandle/dataHandle.js"></script>
</head>
<body>
	<div id="side">
		<div id="menuDiv">
			<button id="toggleDataBtn" >データ取込</button>
			<button id="toggleSearchBtn" >場所を検索</button>
		</div>
		<div id="tantouContainer">
		</div>
	</div>
	<div id="main">
		<div id="middle">
			<div id="map"></div>
		</div>
	</div>
	<!-- サーチボックス -->
	<div id="searchDiv">
		<input type="textbox" id = "searchText" value="" size="40"><button id="searchButton">検索する</button>
	</div>
	<!-- データ取込フォーム -->
	<div id="dataDiv">
		<div id="dataClose" class="clickable">×</div>
		<span id="dataTitle">住所データを「タブ区切りのレコード」で入力</span>
		<p><textarea id="dataText" cols="90" rows="14"></textarea></p>
		<button id="dataBtnImport" >プロット開始</button>
		<input type="checkbox" id="dataChkTrim" checked="true"><label for="dataChkTrim">ゴミ文字を削除</label>
		<input type="checkbox" id="dataChkMansion" checked="true"><label for="dataChkMansion">マンション名を削除</label>
	</div>
	<!-- 住所切替スライド -->
	<div id="slideDiv">
		<div id="slideFirstLine">
			<span id="slideShowList" class="clickable">一覧</span>
			<span id="slideFitsAll" class="clickable">全体</span>
			<span id="slideNowTantou"> 現在表示中の担当者</span>
		</div>
		<div id="slideSecondLine">
			<span id="slideBackward" class="clickable">back</span>
			<span id="slideForward" class="clickable">next</span>
			<span id="slideNowAddress" class="clickable"> 現在表示中の住所名 </span>
		</div>
	</div>

<script>
// -----------------------------------------------------------
	(function(){
		'use strict'
		// --------------------------------------------------------------------
		//  trivial functions
		// --------------------------------------------------------------------
		// 担当者の名前から色を選出する
		function getTantouCssColorText(tantouName){
			var tantouArr =kData.getList('担当者', true);
			var index = tantouArr.indexOf(tantouName);
			var length = tantouArr.length;
			return 'hsla(' +(300/length*index)  + ' , ' + (35+((index%2)*25))+ '%, 50%, 1)'
		}
		//文字列からスペースと”。”を取り除く
		function trimGarbage(str){
				if (typeof str != 'string') return; //throw new Error('string型を引数にいれてください');
				str = str.replace(/[ 　]/g, "");
				str = str.replace(/。/g, "");
				return str;
		}
		// 住所文字列からマンション名（と思われるもの）以降を取り除く
		// 数字より後ろの文字はマンション名と判断する
		function trimMansionOrlater(str){
			// 文字列でない場合は終了
			if (typeof str != 'string') return;
			// 数字と区切り文字の定義
			var arrNumber = '0123456789０１２３４５６７８９';
			var arrDelimiter = '[ 　-ーー〜~−ｰー‐－の丁目]';
			// 実行する
			var flgNumber = false; // 数字がすでに出現している
			for(var i = 0 ; i < str.length ; i++){
				var c = str.charAt(i);
				if (!flgNumber ){
					flgNumber = (arrNumber.indexOf(c) != -1 );
				} else {
					// 数字でもなく、区切り文字でもない
					if (arrNumber.indexOf(c) == -1 && arrDelimiter.indexOf(c) == -1  )
					break;
				}
			}
			return str.substr(0, i);
		}

		// --------------------------------------------------------------------
		//  TantouSpan
		// --------------------------------------------------------------------
		// 担当者ボックスを初期化する
		function setTantouContainer(){

			// エレメントの取得
			var $tantouContainer = $('#tantouContainer');

			// 中の要素を削除する
			$tantouContainer.empty();

			// 各担当者のボタンを作成する
			kData.getList('担当者', true).forEach(function(element){
				var $tantouSpan = createTantouSpan(element);
				$tantouSpan.click(event_TantouSpanClick);
				$tantouContainer.append($tantouSpan);
			});

			// すべて表示ボタンを作成する
			var $selallSpan = createTantouSpan('すべて表示');
			$selallSpan.click(event_SelallSpanClick);
			$tantouContainer.append($selallSpan);
			
			// TantouSpanに変更があったとき
			refleshTantouSpan();
		}

		// 担当者の名前一覧のspanをつくる
		function createTantouSpan(tantouName){
			var $span = $('<span>').attr({id: tantouName, class: 'tantou'});
			$span.append($('<span>').css('background-color', getTantouCssColorText(tantouName)).text('__'));
			$span.append(tantouName);
			return $span;
		}

		// 担当者スパンに特定のクラスが付いているか判別する
		function isTantouClassed(tantou, className){
			if (typeof tantou !== 'string') return false;
			var flg = false;
			$('.tantou').each(function(){
				if ($(this).hasClass(className) && $(this).attr('id') == tantou ){
					flg = true;
				}
			});
			return flg;
		}

		// --------------------------------------------------------------------
		// event_SelallSpanClick
		// --------------------------------------------------------------------
		// すべてを表示ボタンがクリックされた時
		function event_SelallSpanClick(){

			// すべて表示スパンをトグルする
			$(this).toggleClass('marked');

			// スパンをリフレッシュする（ほかのスパンのトグルもこちらで行う）
			refleshTantouSpan();

		}
		// --------------------------------------------------------------------
		// event_TantouSpanClick
		// --------------------------------------------------------------------
		// TantouSpanがクリックされた時 markedクラスを付加する
		function event_TantouSpanClick(){

			// 他のスパンのfocusedクラスを消す
			$(this).siblings().removeClass('focused');

			// focusedクラスをトグルする
			$(this).toggleClass('focused');

			// スパンをリフレッシュする
			refleshTantouSpan();

		};

		// TantouSpanに変更があったときはここを実行する
		function refleshTantouSpan(){

			// すべて表示スパンと他のスパンのmarkedを同期する
			if ($('#すべて表示').hasClass('marked')){
				$('#すべて表示').siblings().addClass('marked');
			}else{
				$('#すべて表示').siblings().removeClass('marked');
			}

			// スライドDIVを消す
			$('#slideDiv').hide();

			// スパンがフォーカスされていたら
			$('.tantou').each(function(){
				if ($(this).hasClass('focused') ){
					// marked
					$(this).addClass('marked');
					//該当担当者の住所リストを優先キューに入れる
					GeoHandle.addAddress(kData.getList('住所', true, '担当者', $(this).attr('id')), true);
					// スライドDIVの設置
					manageSlide(0, true);
					$('#slideDiv').show();
				}
			});

			// スパンをリフレッシュする
			refleshMarker();
		}

		// --------------------------------------------------------------------
		//  createMarker
		// --------------------------------------------------------------------
		// GeoHandleのchacheResultに基づいてマーカーを作成する
		function createMarker(id, result, dataRow, isFocused){

			// richMarkerのプロパティ
			var latlng = result.latlng;
			var labelText = dataRow['担当者'].match(/[^\d:;#]/) + dataRow['訪問順']; // 吹き出しの中身 	// 数字や記号以外で最初の一文字を取得する
			var colorText = getTantouCssColorText(dataRow['担当者']);// 吹き出しの色を取得
			var commentText = result.address; // 横のコメントの内容

			// richmarkerのcontentの作成
			var $contentDiv = $('<div>')
				.attr('id', id)
				.append(
					$('<div>')
						.addClass('marker')
						.css({'background-color' : colorText,'border-top-color':  colorText})
						.text(labelText)
					,$('<div>')
						.addClass('markerComment')
						.addClass((isFocused)? 'markerFocused':'')
						.text(commentText)
				);

				// richMarkerを作成
			var marker = new RichMarker({
				position: latlng,
				map: map,
				flat: true,		//true推奨
				content: $contentDiv[0].outerHTML,
			});

			// クリック時にInfoWindowを作成
			marker.addListener('click', function(e){
				var info = createInfoWindow(dataRow);
				info.open(map, marker);
			});

			// 作成したマーカーを返す
			return marker;
		}

		// InfoWindowを作成
		function createInfoWindow(dataRow){
			// 中身の作成
			var content ='';
			Object.keys(dataRow).forEach(function(k){
				content += k + ':' + dataRow[k] + '<br>';
			});

			// infowindowの作成
			var info = new google.maps.InfoWindow({
				maxWidth:250,
				pixelOffset:{height:-15, width:0},
				content:content,
			});
			// InfoWindowを返す
			return info;
		}

		// --------------------------------------------------------------------
		//  refleshMarker
		// --------------------------------------------------------------------
		// マーカーを再描画する
		function refleshMarker(){

			//	データの担当者一つ一つに対して
			kData.data.forEach(function(dataRow, id){

				// 担当者のスパンがmarked, focusedフラグの取得
				var isMarked = isTantouClassed(dataRow['担当者'], 'marked') ;
				var isFocused = isTantouClassed(dataRow['担当者'], 'focused');

				// 要マーカー作成
				if ( isMarked ){
					// マーカー作成
					if (!markerArr[id]){
						//ジオコーダ取得。
						var result = GeoHandle.cacheResult[dataRow['住所']];
						if (!result || result.address == GeoHandle.TEXT_FAILED) return;			//検索履歴なしもしくは取得失敗なら終了
						// マーカー作成
						markerArr[id] = createMarker(id, result, dataRow, isFocused);
					}
				}else{
					// マーカーの削除
					if(markerArr[id]) markerArr[id].setMap(null);
					markerArr[id] = null;
				}

				// フォーカス時 マーカーのコメント部分にfocusedクラスを付加する
				if ( isFocused ){
					$('#'+id + '>.markerComment').addClass('markerFocused');
				}else{
					$('#'+id + '>.markerComment').removeClass('markerFocused');
				}
		});
		}

		// 指定マーカーに合わせてマップの表示領域を拡大する
		function mymapExpandBounds(marker){
			//var curBounds = myBounds;
			if (!myBounds) myBounds = new google.maps.LatLngBounds();
			if (!myBounds.contains(marker.getPosition())){
				myBounds.extend(marker.getPosition());
				map.fitBounds(myBounds);
			}
		}

		// --------------------------------------------------------------------
		//  importData
		// --------------------------------------------------------------------
		// 渡されたテキストをパースして地図プロットする
		function importData(dataText, isTrimGarbage, isTrimMansion){

			// テキストが空なら終了
			if (!dataText) return;

			// テキストをパースする
			var data = dataHandle.csvParse(dataText, '\t', true);

			// 正しいフィールドを持っているか確認
			if (!data) return;
			if (!data.getList('住所')) return;
			if (!data.getList('担当者')) return;
			if (!data.getList('訪問順')) return;

			// フィールド名と等しい値がある行は削除する
			data.data = data.data.filter(function(row){
				if (row['住所'] ==='住所') return false;
				if (row['担当者']==='担当者') return false;
				if (row['訪問順']==='訪問順') return false;
				return true;
			});

			// Trimフラグがあれば行う
			if (isTrimGarbage){data.data.forEach(function(row){row['住所'] = trimGarbage(row['住所']);});}
			if (isTrimMansion){data.data.forEach(function(row){row['住所'] = trimMansionOrlater(trimGarbage(row['住所']));});}

			// dataをプロット用のデータとして採用する
			kData = data;

			// 新しいデータでマップの初期化をしなおす
			init();
		}

		// --------------------------------------------------------------------
		//  init
		// --------------------------------------------------------------------
		// 担当者ボックスを初期化する、マーカーを初期化する
		function init(){
			// データがなければ終了
			if (!kData) return;

			// 担当者ボックスの初期化
			setTantouContainer();

			// 全マーカの削除
			for (var i = 0; i < markerArr.length ; i++){
				if (markerArr[i]) markerArr[i].setMap(null);
			}
			markerArr = [];

			// 地図の表示範囲初期化
			myBounds = null;

			// GeoHandleオブジェクトの操作
			GeoHandle.onLocate = myCallBack; //マーカーの再描画
			GeoHandle.addAddress(kData.getList('住所', true));
			GeoHandle.doNextSearch();
		}

		// アイテムが取得される度に呼ばれる(geocoderResult)
		function myCallBack(request, result){
			refleshMarker();
		}

		// --------------------------------------------------------------------
		//  dataDiv
		// --------------------------------------------------------------------
		// データ取込フォーム dataDiv関連のイベントを設定する
		function setDataDivEvents(){
			$('#dataBtnImport').click(function(){
				toggleDataDiv();
				importData($('#dataText').val(), $('#dataChkTrim').prop('checked'), $('#dataChkMansion').prop('checked'));
			});
			$('#toggleDataBtn').click(toggleDataDiv);
			$('#dataClose').click(toggleDataDiv)
		}
		// dataDivの表示・非表示を切り返す
		function toggleDataDiv(){
			// DOMの取得
			var $dataDiv = $('#dataDiv');
			var $dataText = $('#dataText');

			// 表示・非表示を切り替える
			$dataDiv.toggle();

			// 表示ＯＮならテキストにフォーカス等の操作をする
			if($dataDiv.is(':visible')){
				setTimeout(function(){
					// 現在のデータをCSVにして再表示
					if (kData) $dataText.val(dataHandle.csvOutput(kData.data, '\t'));
					$dataText.focus();
					$dataText.append('');
				}, 1);
			}
		}
		// --------------------------------------------------------------------
		//  searchDiv
		// --------------------------------------------------------------------
		// サーチボックス 検索場所に新しくマーカーを立てる
		function setSearchDivEvents(){
			$('#searchButton').click(addMarkerSearchDiv);
			$('#toggleSearchBtn').click(toggleSearchDiv);
			$('#searchText').keypress(setFocusSearchBtn);
		}

		function setFocusSearchBtn(e){
			if ( e.keyCode == 13 ) {
				$('#searchButton').focus();
				e.preventDefault();
			}
		}

		function toggleSearchDiv(){
			$('#searchDiv').toggle();
		}

		function addMarkerSearchDiv(){
			var addData = {};
			addData['担当者'] = '他';
			addData['訪問順'] = '';
			addData['住所'] = $('#searchText').val();
			if (!kData){
				kData = new dataHandle.ObjectArray([ addData]);
			}else{
				kData.data.push(addData);
			}

			// 現在の担当スパン状態を取得する
			var isSelAllMarked = $('#すべて表示').hasClass('marked');
			var tantouFocused = $('.tantou.focused').attr('id');

			// マップを初期化し直す
			init();

			// 担当スパン状態を復元する
			if ( isSelAllMarked ) $('#すべて表示').addClass('marked');
			$('.tantou').each(function(){
				if ($(this).attr('id') == tantouFocused) $(this).addClass('focused');
			});

			// スパンをリフレッシュする
			refleshTantouSpan();
		}

		// --------------------------------------------------------------------
		// slideDiv
		// --------------------------------------------------------------------
		// 切替スライドのイベントを設定する
		function setSlideDivEvents(){
			$('#slideForward').click(function(){manageSlide(1);});
			$('#slideBackward').click(function(){manageSlide(-1);});
			$('#slideFitsAll').click(function(){fitMapBoundsFocusedMarkers();});
			$('#slideNowAddress').click(function(){manageSlide(0);})
		}

		// スライドの表示IDを管理・反映
		function manageSlide(increment, isReset){
			// 状態変数の初期化
			if (isReset || typeof manageSlide.id === 'undefined'){
				manageSlide.id = 0;
			}

			// focusedになっている担当スパンの担当者名を取得
			var focused = $('.tantou.focused').attr('id');

			// focused担当者のデータ一覧を取得
			var newData = kData.data.filter(function(row){return row['担当者']==focused});

			// 状態変数増減させる
			manageSlide.id += increment
			manageSlide.id = Math.max(manageSlide.id, 0);
			manageSlide.id = Math.min(manageSlide.id,  newData.length - 1);

			// 表示中の行を取得
			var　curRow = newData[manageSlide.id];
			// var curRow['住所'] = newData[manageSlide.id]['住所'];

			// slideNowAddressに表示させる
			if (focused){$('#slideNowAddress').text( curRow['住所']);}

			// slideNowTantouに情報を表示
			if (focused){
				$('#slideNowTantou').empty();
				$('#slideNowTantou').append(
					$('<span>')
						.css('background-color', getTantouCssColorText(focused))
						.text('__'));
				$('#slideNowTantou').append(focused + '（' +  manageSlide.id+ '）');
			}

			// 座標の変更
			var result = GeoHandle.cacheResult[curRow['住所']];
			if ( !result || result.address == GeoHandle.TEXT_FAILED) return;
			map.setCenter(result.latlng);

			//var addressArr = kData.getList('住所', true, '担当者', focused, '訪問順', true);
			// // 状態変数増減させる
			// manageSlide.id += increment;
			// manageSlide.id = Math.max(manageSlide.id, 0);
			// manageSlide.id = Math.min(manageSlide.id,  addressArr.length - 1);
			//
			// // 住所の取得
			// var address = addressArr[manageSlide.id];
			//
			// // slideNowAddressに表示させる
			// if (focused){$('#slideNowAddress').text( address);}
			//
			// // slideNowTantouに情報を表示
			// if (focused){
			// 	$('#slideNowTantou').empty();
			// 	$('#slideNowTantou').append($('<span>').css('background-color', getTantouCssColorText(focused[0])).text('__'));
			// 	$('#slideNowTantou').append(focused[0] + '（' +  (manageSlide.id + 1) + '）');
			// }
			//
			// // 座標の変更
			// var result = GeoHandle.cacheResult[address];
			// if ( !result || result.address == GeoHandle.TEXT_FAILED) return;
			// map.setCenter(result.latlng);
		}

		//focused中のマーカーを表示するようにマップの表示領域を変更する
		function fitMapBoundsFocusedMarkers(){
			// マーカーが一つでもある場合trueになる
			var flgMarkerFound = false;

			//	データの担当者一つ一つに対して
			kData.data.forEach(function(dataRow, id){
				if (isTantouClassed(dataRow['担当者'], 'focused')){
					if (markerArr[id]){
						// 一つ目の場合、myBoundを初期化
						if (!flgMarkerFound) myBounds = null;
						flgMarkerFound = true;

						//表示領域を広げる
						mymapExpandBounds(markerArr[id]);
					}
				}
			});
		}

		// --------------------------------------------------------------------
		function getMyMapOption(){

			// TODO リテラルをここに書くのか
			var mapCenter = {lat:35.5, lng:139.6};
			var	mapzoom = 14;

			return {
				center:mapCenter,
				zoom:mapzoom,
				mapTypeControl:false,
				streetViewControlOptions:{
					position: google.maps.ControlPosition.RIGHT_CENTER,
				},
				zoomControlOptions:{
					position: google.maps.ControlPosition.RIGHT_CENTER,
					style:google.maps.ZoomControlStyle.LARGE
				},
				scaleControl: true,
	  		scaleControlOptions: {
	    	position: google.maps.ControlPosition.BOTTOM_LEFT
	  		},
			};
		}

		// --------------------------------------------------------------------
		//  main
		// --------------------------------------------------------------------
		// 取り込みボタンのイベントを設定する
		setDataDivEvents();

		// 検索ボタンのイベントを設定する
		setSearchDivEvents();

		// 切替スライドのイベントを設定する
		setSlideDivEvents();

		// data ObjectArray オブジェクト dataImportないで初期化される
		var kData;

		// マーカー配列を用意
		var markerArr = [];

		// マップの表示領域を格納する
		var myBounds = new google.maps.LatLngBounds();

		// googleマップの読込み
		var map = new google.maps.Map($('#map')[0], getMyMapOption());

		// geocoderキャッシュ管理オブジェクトを初期化
		GeoHandle.init();

		// 呼出パラメータでマップを生成する
		if (location.hash.length >= 0){
			importData(decodeURI(location.hash.substring(1)), true ,true);// default true true
		}
	})();

</script>
</body>
</html>
