<!DOCTYPE HTML>
<!--
やること
		ちょっと検索ダイアログでマーカー追加

		全て表示するボタンの実装　
			全て非表示ボタンも実装

		担当一覧のクラス	visible	担当のマーカーが見える状態
											focused	担当の訪問先一覧が表示されている状態　fixedサイドDivで表示
		fixedサイドバー
			dipslay none <>
			fixedで表示を切り替え
			またはホーバーで広がるサイドバー

		仮マーカーの実装　
			あらかじめ各町のlatlngを取得しておく
			要外部DBへの接続実装
-->


<html lang="ja">
<head>
	<title>地図プロット</title>
	<meta charset="utf-8">
	<link rel="stylesheet" href="geoHandle.css" type="text/css">
	<script src="http://maps.google.com/maps/api/js?language=ja"></script>
	<script src="https://google-maps-utility-library-v3.googlecode.com/svn-history/r213/trunk/richmarker/src/richmarker-compiled.js"></script>
	<!-- <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script> -->
	<script src="geoHandle.js"></script>
	<script src="./dataHandle.js"></script>
	<script src="../dataHandle/dataHandle.js"></script>
</head>
<body>
	<div id="side">
		<div id="toggle">
			<button id="toggleBtn" >データ取込フォーム</button>
		</div>
		<div id="tantouDiv"></div>
	</div>
	<div id="main">
		<div id="top">
			<div id="status"></div>
		</div>
		<div id="middle">
			<div id="map"></div>
		</div>
	</div>
	<div id="dataDiv">
		<div id="dataClose">×</div>
		<span id="dataTitle">住所データを「タブ区切りのレコード」で入力</span>
		<p><textarea id="dataText" cols="90" rows="14"></textarea></p>
		<button id="dataBtnImport" >プロット開始</button>
		<input type="checkbox" id="dataChkTrim" checked="true"><label for="dataChkTrim">ゴミ文字を削除</label>
		<input type="checkbox" id="dataChkMansion" checked="true"><label for="dataChkMansion">マンション名削除</label>
	</div>
<script>
// -----------------------------------------------------------
	(function(){
		'use strict'
		// --------------------------------------------------------------------
		//  trivial functions
		// --------------------------------------------------------------------
		 // tagを作る
		function createTag(strTag, attributes, innerText){
		    var temp = document.createElement(strTag);
		    if(typeof attributes == 'object'){
		      Object.keys(attributes).forEach(function(k){
		        temp.setAttribute(k, attributes[k]);
		      });
		    }
		    if(innerText){ temp.innerText = innerText; }
		    return temp;
		}

		// 担当者の名前から色を選出する
		function getTantouCssColorText(tantouName){
			var tantouArr =kData.getList('担当者', true);
			var index = tantouArr.indexOf(tantouName);
			var length = tantouArr.length;
			return 'hsla(' +(300/length*index)  + ' , ' + (35+((index%2)*25))+ '%, 50%, 1)'
		}
		//文字列からスペースと”。”を取り除く
		function trimGarbage(str){
				if (typeof str != 'string') return; //throw new Error('string型を引数にいれてください');
				str = str.replace(/[ 　]/g, "");
				str = str.replace(/。/g, "");
				return str;
		}
		// 住所文字列からマンション名（と思われるもの）以降を取り除く
		// 数字より後ろの文字はマンション名と判断する
		function trimMansionOrlater(str){
			// 文字列でない場合は終了
			if (typeof str != 'string') return;
			// 数字と区切り文字の定義
			var arrNumber = '0123456789０１２３４５６７８９';
			var arrDelimiter = '[ 　-ーー〜~−ｰー‐－の丁目]';
			// 実行する
			var flgNumber = false; // 数字がすでに出現している
			for(var i = 0 ; i < str.length ; i++){
				var c = str.charAt(i);
				if (!flgNumber ){
					flgNumber = (arrNumber.indexOf(c) != -1 );
				} else {
					//　数字でもなく、区切り文字でもない
					if (arrNumber.indexOf(c) == -1 && arrDelimiter.indexOf(c) == -1  )
					break;
				}
			}
			//if (i != str.length) console.log(str.substr(0,i) + ':' + str.substr(i, str.length - i));
			return str.substr(0, i);
		}

		// --------------------------------------------------------------------
		//  setTantouDiv
		// --------------------------------------------------------------------
		// 担当者ボックスを初期化する
		function setTantouDiv(){
			// エレメントの取得
			var tantouDiv = document.getElementById('tantouDiv');

			// 中のエレメントを削除する
			while(tantouDiv.firstChild){
				tantouDiv.removeChild(tantouDiv.firstChild);
			}

			// 工事データから担当者の一意データを取得して、担当者ボックスに格納する
			kData.getList('担当者', true).forEach(function(element, index, array){
				tantouDiv.appendChild( createTantouSpan(element));
			});

			//　全ての担当の表示非表示を切り変える
			tantouDiv.appendChild( createTantouSpan('すべて選択'));

			// クリック時のアクションを設定する
			tantouDiv.addEventListener('click', event_Div_TantouClick);
		}
		// 担当者の名前一覧のspanをつくる
		function createTantouSpan(tantouName){
			var span = createTag('span', {id: tantouName, class: 'tantou selected', selected : true});
			var styleText = 'background-color:' + getTantouCssColorText(tantouName) +';';
			span.appendChild(createTag('span', {style: styleText}, '__'));
			span.appendChild(document.createTextNode(tantouName));
			// var span = document.createElement('span');
			// span.className = "tantou";
			// span.id = tantouName;		// id 担当者
			// span.setAttribute('selected', 'false');
			// var colorText = getTantouCssColorText(tantouName);
			// var colorDivTag = '<span style = "background-color:' + colorText+';">__</span>';
			// span.innerHTML = colorDivTag + ' ' +tantouName;

			// // 一つ目の要素は選択ＯＮにしておく
			// if (index == 0){
			// 	span.setAttribute('selected', 'true');
			// 	span.className = 'tantou selected';
			// }
			return span;
		}
		// --------------------------------------------------------------------
		//  event_Div_TantouClick
		// --------------------------------------------------------------------
		// 担当者ボックスがクリックされたとき
		function event_Div_TantouClick(event){

			// DOMの取得
			var t = event.target;

			// 担当者以外がクリックされていたら終了//
			if (t.className.indexOf('tantou')<0) return;

			// クリックされた担当者の選択状態を反転させる
			if (t.getAttribute('selected') =='true'){
				t.setAttribute('selected', 'false');
				t.className = 'tantou';
			}else{
				t.setAttribute('selected', 'true');
				t.className = 'tantou selected';
			}

			// SELECT ALL 押した時のアクション
			toggleTantouSpanSelected();
			
			
			//
			
			
			// 担当者の住所リストを優先キューに入れる
			GeoHandle.addAddress(kData.getList('住所', true, '担当者', t.id), true);

			// マーカーをリフレッシュする
			myBounds = null;
			refleshMarker();
		}
		
		//TODO SELECT ALL 押した時のアクション
		function toggleTantouSpanSelected(){
		
		}

		// --------------------------------------------------------------------
		//  createMarker
		// --------------------------------------------------------------------
		// GeoHandleのchacheResultに基づいてマーカーを作成する
		function createMarker( result, dataRow){

			// richMarkerをつくる
			var marker = createRichMarker( result, dataRow);

			// InfoWindowをつくってイベントに紐付けする
			marker.addListener('click', function(e){
				var info = createInfoWindow(dataRow);
				info.open(map, marker);
			});

			// 作成したマーカーを返す
			return marker;

		}
		// richMarkerをつくる
		function createRichMarker( result, dataRow){

			// 吹き出しに表示するテキストを設定
			var labelText = dataRow['担当者'].substr(4,1) + dataRow['訪問順']; // var labelText = dataRow['訪問順'];

			// 吹き出しの色を取得
			var colorText = getTantouCssColorText(dataRow['担当者']);

			// 横のコメントを設定
			var comment = result.address;

			// richmarkerのcontentの作成
			var contentDiv = createTag('div', {}, '');
			contentDiv.appendChild(createTag('div', {'class':'marker', 'style':'background-color:' + colorText + '; border-top-color:' + colorText + ';'}, labelText));
			contentDiv.appendChild(createTag('div', {'class':'markerComment'}, comment));

			// マーカーの作成
			var marker = new RichMarker({
				position: result.latlng,
				map: map,
				flat: true,		//true推奨
				content: contentDiv.outerHTML,
			});

			// マーカーを設置する
			return marker;
		}

		// InfoWindowを作成
		function createInfoWindow(dataRow){
			// 中身の作成
			var content ='';
			Object.keys(dataRow).forEach(function(k){
				content += k + ':' + dataRow[k] + '<br>';
			});

			// infowindowの作成
			var info = new google.maps.InfoWindow({
				maxWidth:250,
				pixelOffset:{height:-15, width:0},
				content:content,
			});
			// InfoWindowを返す
			return info;
		}

		// --------------------------------------------------------------------
		//  refleshMarker
		// --------------------------------------------------------------------
		// マーカーを再描画する
		function refleshMarker(){

			//	表示ON状態の担当者のリストを取得
			var nowTantouArr = kData.getList('担当者', true).filter(function(tantou){
				return document.getElementById(tantou).getAttribute('selected') == 'true';
			});

			//	データの担当者一つ一つに対して
			kData.data.forEach(function(dataRow, id){
				// ------表示ONのリストに名前があれば
				if (nowTantouArr.indexOf(dataRow['担当者']) >= 0 ){
						// 住所キャッシュの取得
						var result = GeoHandle.cacheResult[dataRow['住所']];
						//ジオコーダ取得失敗なら終了
						if (!result) return;
						// マーカーが未作成なら作成
						if (markerArr[id] == null) markerArr[id] = createMarker( result, dataRow); // マーカーを作成
						// マップの表示領域を拡大する
						mymapExpandBounds(markerArr[id]); 
						
				// ------表示ONのリストに名前がなければ
				}else {
						// マーカーの削除
						if(markerArr[id]) markerArr[id].setMap(null);
						markerArr[id] = null;
				}
			});
		}
		// 指定マーカーに合わせてマップの表示領域を拡大する
		function mymapExpandBounds(marker){
			//var curBounds = myBounds;
			if (!myBounds) myBounds = new google.maps.LatLngBounds();
			if (!myBounds.contains(marker.getPosition())){
				myBounds.extend(marker.getPosition());
				map.fitBounds(myBounds);
			}
		}

		// --------------------------------------------------------------------
		//  importData
		// --------------------------------------------------------------------
		// 渡されたテキストをパースして地図プロットする
		function importData(dataText, isTrimGarbage, isTrimMansion){
			// 指定がなければのdataTextエレメントのテキストでパースする
			if (!dataText) return;
			var data = dataHandle.csvParse(dataText, '\t', true);

			// 正しいフィールドを持っているか確認
			if (!data) return;
			if (!data.getList('住所')) return;
			if (!data.getList('担当者')) return;
			if (!data.getList('訪問順')) return;
			
			// フィールド名と等しい値がある行は削除する
			data.data = data.data.filter(function(row){
				if (row['住所'] ==='住所') return false;
				if (row['担当者']==='担当者') return false;
				if (row['訪問順']==='訪問順') return false;
				return true;
			});
			
			// Trimフラグがあれば行う
			if (isTrimGarbage){data.data.forEach(function(row){row['住所'] = trimGarbage(row['住所']);});}
			if (isTrimMansion){data.data.forEach(function(row){row['住所'] = trimMansionOrlater(trimGarbage(row['住所']));});}

			// 問題なければ新しいデータでマップの初期化を行う
			init(data);
		}
		// --------------------------------------------------------------------
		//  dataDiv
		// --------------------------------------------------------------------
		function toggleDataDiv(visible){
			var dataDiv = document.getElementById('dataDiv');
			var dataText = document.getElementById('dataText');

			// noinput then toggle
			if (visible===undefined){
					visible = (dataDiv.style.visibility != 'visible')
			}
			//
			if (visible){
				dataDiv.style.visibility = 'visible';
				dataText.focus();
				dataText.select();
			}else{
				dataDiv.style.visibility = 'hidden';
			}
		}

		// --------------------------------------------------------------------
		//  init
		// --------------------------------------------------------------------
		// 渡されたデータでマップを初期化する kDataを初期化する
		function init(data){
			// 引数のデータを工事データ配列格納
			kData = data;

			// 全マーカの削除
			for (var i = 0; i < markerArr.length ; i++){
				if (markerArr[i]) markerArr[i].setMap(null);
			}
			markerArr = [];

			// 担当者ボックスの初期化
			setTantouDiv();

			// GeoHandleの初期化
			//GeoHandle.init();			// キャッシュが消えるのでmainにて呼出

			// Geocoder成功時のコールバックを設定
			GeoHandle.onLocate = myCallBack; //マーカーの再描画

			// Geocoderで調べる住所一覧を登録
			GeoHandle.addAddress(kData.getList('住所', true));

			// GeoHandleの検索開始
			GeoHandle.doNextSearch();
		}

		// アイテムが取得される度に呼ばれる(geocoderResult)
		function myCallBack(request, result){
			refleshMarker();
		}

		// --------------------------------------------------------------------
		//  main
		// --------------------------------------------------------------------
		// 取り込みボタンのイベントを設定する
		document.getElementById('dataBtnImport').addEventListener('click', function(){
			var dataText = document.getElementById('dataText');
			var dataChkTrim = document.getElementById('dataChkTrim');
			var dataChkMansion = document.getElementById('dataChkMansion');
			importData(dataText.value, dataChkTrim.checked, dataChkMansion.checked);
			toggleDataDiv(false);
		});
		document.getElementById('toggleBtn').addEventListener('mousedown', function(){
			toggleDataDiv();});
		document.getElementById('dataClose').addEventListener('click', function(){
			toggleDataDiv(false);});

		// 工事データ配列 init関数で初期化される
		var kData = [];

		// マーカー配列を用意
		var markerArr = [];

		// マップの表示領域を格納する
		var myBounds = new google.maps.LatLngBounds(); 

		// マップの初期表示を定める
		var mapCenter = {lat:35.5, lng:139.6};
		var	mapzoom = 14;
		
		// geocoderキャッシュ管理オブジェクトを初期化
		GeoHandle.init();

		// googleマップの読込み
		var map = new google.maps.Map(document.getElementById('map'), {center:mapCenter,zoom:mapzoom});

		// 呼出パラメータでマップを生成する
		if (location.hash.length >= 0){
			importData(decodeURI(location.hash.substring(1)));
		}


	})();

</script>
</body>
</html>
