<!DOCTYPE html>
<!--
やること

		fixedサイドバー
			dipslay none <>
			fixedで表示を切り替え
			またはホーバーで広がるサイドバー

		仮マーカーの実装　
			あらかじめ各町のlatlngを取得しておく
			要外部DBへの接続実装
-->


<html lang="ja">
<head>
	<title>地図プロット</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.18.1/build/cssreset/cssreset-min.css">
	<link rel="stylesheet" href="geoHandle.css" type="text/css">
	<script src="http://maps.google.com/maps/api/js?language=ja"></script>
	<script src="https://google-maps-utility-library-v3.googlecode.com/svn-history/r213/trunk/richmarker/src/richmarker-compiled.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="geoHandle.js"></script>
	<script src="./dataHandle.js"></script>
	<script src="../dataHandle/dataHandle.js"></script>
</head>
<body>
	<!-- main -->
	<div id="main">
		<div id="middle">
			<div id="map"></div>
		</div>
	</div>
	<!-- sideDiv -->
	<div id="sideDiv">
		<div id="menuDiv">
			<p><button id="toggleDataBtn" >データ取込</button></p>
			<p><button id="toggleSearchBtn" >場所を検索</button></p>
			<p><button id="toggleTantouBtn" >表示担当一覧</button></p>
		</div>
		<div id="tantouDiv">
		</div>
	</div>
	<!-- サーチボックス -->
	<div id="searchDiv">
		<input type="textbox" id = "searchText" value="" size="40"><button id="searchButton">場所を追加</button>
	</div>
	<!-- 住所切替スライド -->
	<div id="slideDiv">
		<div id="slideFirstLine">
			<span id="slideBackward" class="clickable">back</span>
			<span id="slideNowTantou" class="clickable" title="コース全体を表示"> 現在表示中の担当者</span>
		</div>
		<div id="slideSecondLine">
			<span id="slideForward" class="clickable">next</span>
			<span id="slideNowAddress" class="clickable" title="マップの中心に表示"> 現在表示中の住所名 </span>
		</div>
	</div>
	<!-- 担当フォーカス切替　セレクトボックス -->
	<div id="switchDiv">
		<select id="switchSelect"></select>
	</div>
	<!-- データ取込フォーム -->
	<div id="dataDiv">
		<div id="dataClose" class="clickable">×</div>
		<span id="dataTitle">住所データを「タブ区切りのレコード」で入力</span>
		<p><textarea id="dataText"></textarea></p>
		<button id="dataBtnImport" >プロット開始</button>
		<input type="checkbox" id="dataChkUnique" checked="true">
			<label for="dataChkUnique">重複行を削除</label>
		<input type="checkbox" id="dataChkTrim" checked="true">
			<label for="dataChkTrim">ゴミ文字を削除</label>
		<input type="checkbox" id="dataChkMansion" checked="true">
			<label for="dataChkMansion">マンション名を削除</label>
	</div>
<script>
// -----------------------------------------------------------
	(function(){
		'use strict'
		// --------------------------------------------------------------------
		//  functions 他のプロジェクトでも使えそうなもの
		// --------------------------------------------------------------------
		//文字列からスペースと”。”を取り除く
		function trimGarbage(str){
				if (typeof str != 'string') return; //throw new Error('string型を引数にいれてください');
				str = str.replace(/[ 　]/g, "");
				str = str.replace(/。/g, "");
				return str;
		}
		// 住所文字列からマンション名（と思われるもの）以降を取り除く  数字より後ろの文字はマンション名と判断する
		function trimMansionOrlater(str){
			// 文字列でない場合は終了
			if (typeof str != 'string') return;
			// 数字と区切り文字の定義
			var arrNumber = '0123456789０１２３４５６７８９';
			var arrDelimiter = '[ 　-ーー〜~−ｰー‐－の丁目]';
			// 実行する
			var flgNumber = false; // 数字がすでに出現している
			for(var i = 0 ; i < str.length ; i++){
				var c = str.charAt(i);
				if (!flgNumber ){
					flgNumber = (arrNumber.indexOf(c) != -1 );
				} else {
					// 数字でもなく、区切り文字でもない
					if (arrNumber.indexOf(c) == -1 && arrDelimiter.indexOf(c) == -1  )
					break;
				}
			}
			return str.substr(0, i);
		}

		// セレクタで使われる記号をエスケープする
		function selectorEscape(val){
		    return val.replace(/[ !"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~]/g, '\\$&');
		}

		// 配列のレコード重複をなくす　 TODO 無理やりすぎる？
		function getUniqueRecordArray(array) {
			var storage = {};
			return array.filter(function(value){
				if (!(JSON.stringify(value) in storage)) {
					storage[JSON.stringify(value)] = true;
					return true;
				}
			});
		}

		// --------------------------------------------------------------------
		//  unique function このファイル固有の関数
		// --------------------------------------------------------------------
		// 担当者の名前から色を選出する
		function getTantouCssColorText(tantouName){
			var tantouArr =myData.getList('担当者', true);
			var index = tantouArr.indexOf(tantouName);
			var length = tantouArr.length;
			return 'hsla(' +(300/length*index)  + ' , ' + (35+((index%2)*25))+ '%, 50%, 1)'
		}

		// 指定した担当スパンをフォーカス状態にする
		function changeFocusedTantou(tantou){
			// セレクタに使う記号をエスケープする
			tantou = selectorEscape(tantou);
			// 他の担当スパンのフォーカスを消す
			$('#' + tantou).siblings().removeClass('focused');
			$('#' + tantou).addClass('focused');
			// スパン変更時のアクションを実行
			refleshTantouSpan();
		}

		// focused担当者のデータ一覧を取得
		function getFocusedTantouData(){
			var tantou = $('.tantou.focused').attr('id');
			var newData = myData.data.filter(function(row){
				return row['担当者']==tantou}
			);
			return newData;
		}


		//focused中のマーカーを表示するようにマップの表示領域を変更する
		function fitMapBoundsFocusedMarkers(){

			//	データの担当者一つ一つに対して
			var flgFirst = false;
			myData.data.forEach(function(dataRow, id){
				if (isTantouClassed(dataRow['担当者'], 'focused')){
					if (myMarkerArr[id]){
						// 一つ目の場合、myBoundを初期化
						if (!flgFirst) myBounds = null;
						flgFirst = true;
						//表示領域を広げる
						mapExpandBounds(myMarkerArr[id]);
					}
				}
			});
		}
		// 指定マーカーに合わせてマップの表示領域を拡大する
		function mapExpandBounds(marker){
			//var curBounds = myBounds;
			if (!myBounds) myBounds = new google.maps.LatLngBounds();
			if (!myBounds.contains(marker.getPosition())){
				myBounds.extend(marker.getPosition());
				myMap.fitBounds(myBounds);
			}
		}


		// 担当者スパンに特定のクラスが付いているか判別する
		function isTantouClassed(tantou, className){
			if (typeof tantou !== 'string') return false;
			var flg = false;
			$('.tantou').each(function(){
				if ($(this).hasClass(className) && $(this).attr('id') == tantou ){
					flg = true;
				}
			});
			return flg;
		}

		// --------------------------------------------------------------------
		//  TantouSpan
		// --------------------------------------------------------------------
		// 担当者ボックスを初期化する
		function settantouDiv(){

			// エレメントの取得
			var $tantouDiv = $('#tantouDiv');

			// 中の要素を削除する
			$tantouDiv.empty();

			// 各担当者のボタンを作成する
			myData.getList('担当者', true).forEach(function(element){
				var $tantouSpan = createTantouSpan(element);
				$tantouSpan.click(event_TantouSpanClick);
				$tantouSpan.appendTo($tantouDiv);
			});

			// すべて表示ボタンを作成する
			var $selallSpan = createTantouSpan('すべて表示');
			$selallSpan.click(event_SelallSpanClick);
			$selallSpan.appendTo($tantouDiv);

			// TantouSpanに変更があったとき
			refleshTantouSpan();
		}

		function toggleTantouDiv(){
			$('#tantouDiv').toggle();
		}

		// 担当者の名前一覧のspanをつくる
		function createTantouSpan(tantouName){
			var $span = $('<span>').attr({id: tantouName, class: 'tantou marked'});
			$span.append($('<span>').css('background-color', getTantouCssColorText(tantouName)).text('__'));
			$span.append(tantouName);
			return $span;
		}


		// --------------------------------------------------------------------
		// event_SelallSpanClick
		// --------------------------------------------------------------------
		// すべてを表示ボタンがクリックされた時
		function event_SelallSpanClick(){

			// すべて表示スパンをトグルする
			$(this).toggleClass('marked');

			// すべて表示スパンと他のスパンのmarkedを同期する
			if ($(this).hasClass('marked')){
				$(this).siblings().addClass('marked');
			}else{
				$(this).siblings().removeClass('marked');
			}

			// TantouSpanに変更があったときのアクションを実行する
			refleshTantouSpan();

		}
		// --------------------------------------------------------------------
		// event_TantouSpanClick
		// --------------------------------------------------------------------
		// TantouSpanがクリックされた時 markedクラスを付加する
		function event_TantouSpanClick(){

			// markedクラスをトグルする
			$(this).toggleClass('marked');

			// TantouSpanに変更があったときのアクションを実行する
			refleshTantouSpan();
		};

		// TantouSpanに変更があったときのアクションを実行する
		function refleshTantouSpan(){

			// スライドDIVを消す
			$('#slideDiv').hide();

			// フォーカスされているスパンについて
			if ($('.tantou.focused')[0]){

				// 優先的に住所を調べる
				GeoHandle.addAddress(myData.getList('住所', true, '担当者', $('.tantou.focused').attr('id')), true);

				// スライドの表示IDを管理・反映
				manageSlide(0, 0);

				// スライドDIVを再表示
				$('#slideDiv').show();
			}

			// スパンをリフレッシュする
			refleshMarker();
		}

		// --------------------------------------------------------------------
		//  createMarker
		// --------------------------------------------------------------------
		// GeoHandleのchacheResultに基づいてマーカーを作成する
		function createMarker(id, result, dataRow, isFocused){

			// richMarkerのプロパティ
			var latlng = result.latlng;
			var labelText = dataRow['担当者'].match(/[^\d:;#]/) + dataRow['訪問順']; // 吹き出しの中身 	// 数字や記号以外で最初の一文字を取得する
			var colorText = getTantouCssColorText(dataRow['担当者']);// 吹き出しの色を取得
			var commentText = result.address; // 横のコメントの内容

			// richmarkerのcontentの作成
			var $contentDiv = $('<div>')
				.attr('id', id)
				.attr('title', commentText)
				.append(
					$('<div>')
						.addClass('marker')
						.css({'background-color' : colorText,'border-top-color':  colorText})
						.text(labelText)
					,$('<div>')
						.addClass('markerComment')
						.addClass((isFocused)? 'markerFocused':'')
						.text(commentText)
				);

				// richMarkerを作成
			var marker = new RichMarker({
				position: latlng,
				map: myMap,
				flat: true,		//true推奨
				content: $contentDiv[0].outerHTML,
			});

			// クリック時にInfoWindowを作成
			marker.addListener('click', function(e){
				var info = createInfoWindow(dataRow);
				info.open(myMap, marker);
			});

			// 作成したマーカーを返す
			return marker;
		}

		// InfoWindowを作成
		function createInfoWindow(dataRow){
			// 中身の作成
			var content ='';
			Object.keys(dataRow).forEach(function(k){
				content += k + ':' + dataRow[k] + '<br>';
			});

			// infowindowの作成
			var info = new google.maps.InfoWindow({
				maxWidth:250,
				pixelOffset:{height:-15, width:0},
				content:content,
			});
			// InfoWindowを返す
			return info;
		}

		// --------------------------------------------------------------------
		//  refleshMarker
		// --------------------------------------------------------------------
		// マーカーを再描画する
		function refleshMarker(){

			//	データの担当者一つ一つに対して
			myData.data.forEach(function(dataRow, id){

				// 担当者のスパンがmarked, focusedフラグの取得
				var isMarked = isTantouClassed(dataRow['担当者'], 'marked') ;
				var isFocused = isTantouClassed(dataRow['担当者'], 'focused');

				// 要マーカー作成
				if ( isMarked || isFocused){
					// マーカー作成ああ
					if (!myMarkerArr[id]){
						//ジオコーダ取得。
						var result = GeoHandle.cacheResult[dataRow['住所']];
						if (!result || result.address == GeoHandle.TEXT_FAILED) return;			//検索履歴なしもしくは取得失敗なら終了
						// マーカー作成
						myMarkerArr[id] = createMarker(id, result, dataRow, isFocused);
					}
				}else{
					// マーカーの削除
					if(myMarkerArr[id]) myMarkerArr[id].setMap(null);
					myMarkerArr[id] = null;
				}

				// フォーカス時 マーカーのコメント部分にfocusedクラスを付加する
				if ( isFocused ){
					$('#'+id + '>.markerComment').addClass('markerFocused');
				}else{
					$('#'+id + '>.markerComment').removeClass('markerFocused');
				}
		});
		}



		// --------------------------------------------------------------------
		//  importData
		// --------------------------------------------------------------------
		// 渡されたテキストをパースして地図プロットする
		function importData(dataText, isUniqueRecord, isTrimGarbage, isTrimMansion){

			// テキストが空なら終了
			if (!dataText) return;

			// #で始まる行は制御文 処理した上で取り除く
			var lines = dataText.split('\n');
			dataText ='';
			for (var i=0;  i < lines.length; i++ ){
				if (lines[i].substr(0,1) == '#'){
					var param = lines[i].substr(1).split(':');
					switch (param[0]){
						case 'title': myTitle = param[1]; break;
						case 'groupby': myGroupBy = param[1]; break;
						case 'sortby': mySortBy = param[1]; break;
						case 'plotby': myPlotBy = param[1]; break;
					}
				}else {
					// その他のデータはdataTextに入れ直す
					dataText += lines[i] + '\n';
				}
			}

			// テキストをパースする
			var data = dataHandle.csvParse(dataText, '\t', true);

			// 正しいフィールドを持っているか確認
			if (!data) return;
			if (!data.getList('住所')) return;
			if (!data.getList('担当者')) return;
			if (!data.getList('訪問順')) return;

			// フィールド名と等しい値がある行は削除する
			data.data = data.data.filter(function(row){
				if (row['住所'] ==='住所') return false;
				if (row['担当者']==='担当者') return false;
				if (row['訪問順']==='訪問順') return false;
				return true;
			});

			// 重複したレコードがあれば削除する
			if (isUniqueRecord){data.data = getUniqueRecordArray(data.data)};

			// Trimフラグがあれば行う
			if (isTrimGarbage){data.data.forEach(function(row){row['住所'] = trimGarbage(row['住所']);});}
			if (isTrimMansion){data.data.forEach(function(row){row['住所'] = trimMansionOrlater(trimGarbage(row['住所']));});}

			// dataをプロット用のデータとして採用する
			myData = data;

			// 新しいデータでマップの初期化をしなおす
			initializeMap();
		}

		// --------------------------------------------------------------------
		//  initializeMap
		// --------------------------------------------------------------------
		// 担当者ボックスを初期化する、マーカーを初期化する
		function initializeMap(){
			// データがなければ終了
			if (!myData) return;

			// 担当者ボックスの初期化
			settantouDiv();

			setswitchDiv();

			// 全マーカの削除
			for (var i = 0; i < myMarkerArr.length ; i++){
				if (myMarkerArr[i]) myMarkerArr[i].setMap(null);
			}
			myMarkerArr = [];

			// 地図の表示範囲初期化
			myBounds = null;

			// GeoHandleオブジェクトの操作
			GeoHandle.onLocate = myCallBack; //マーカーの再描画
			GeoHandle.addAddress(myData.getList('住所', true));
			GeoHandle.doNextSearch();

			refleshMarker();
		}

		// アイテムが取得される度に呼ばれる(geocoderResult)
		function myCallBack(request, result){
			refleshMarker();
		}

		// --------------------------------------------------------------------
		//  dataDiv
		// --------------------------------------------------------------------
		// データ取込フォーム dataDiv関連のイベントを設定する
		function setDataDivEvents(){
			$('#dataBtnImport').click(function(){
				toggleDataDiv();
				importData(
					$('#dataText').val(),
					$('#dataChkUnique').prop('checked'),
					$('#dataChkTrim').prop('checked'),
					$('#dataChkMansion').prop('checked')
				);
			});
			$('#dataClose').click(toggleDataDiv)
		}
		// dataDivの表示・非表示を切り返す
		function toggleDataDiv(){
			// DOMの取得
			var $dataDiv = $('#dataDiv');
			var $dataText = $('#dataText');

			// 表示・非表示を切り替える
			$dataDiv.toggle();

			// 表示ＯＮならテキストにフォーカス等の操作をする
			if($dataDiv.is(':visible')){
				setTimeout(function(){
					// 現在のデータをCSVにして再表示
					if (myData) $dataText.val(dataHandle.csvOutput(myData.data, '\t'));
					$dataText.focus();
					$dataText.append('');
				}, 1);
			}
		}
		// --------------------------------------------------------------------
		//  searchDiv
		// --------------------------------------------------------------------
		// サーチボックス 検索場所に新しくマーカーを立てる
		function setSearchDivEvents(){
			$('#searchButton').click(addMarkerSearchDiv);
			$('#searchText').keypress(setFocusSearchBtn);
		}

		function setFocusSearchBtn(e){
			if ( e.keyCode == 13 ) {
				$('#searchButton').focus();
				e.preventDefault();
			}
		}

		function toggleSearchDiv(){
			$('#searchDiv').toggle();
		}

		// 検索した住所をマーカーにする
		function addMarkerSearchDiv(){
			var addData = {};
			addData['担当者'] = '他';
			addData['訪問順'] = '';
			addData['住所'] = $('#searchText').val();
			if (!myData){
				myData = new dataHandle.ObjectArray([ addData]);
			}else{
				myData.data.push(addData);
			}

			// 現在の担当スパン状態を取得する
			var isSelAllMarked = $('#すべて表示').hasClass('marked');
			var tantouFocused = $('.tantou.focused').attr('id');

			// マップを初期化し直す
			initializeMap();

			// 担当スパン状態を復元する
			if ( isSelAllMarked ) $('#すべて表示').addClass('marked');
			$('.tantou').each(function(){
				if ($(this).attr('id') == tantouFocused) $(this).addClass('focused');
			});

			// スパンをリフレッシュする
			refleshTantouSpan();
		}

		// --------------------------------------------------------------------
		// slideDiv
		// --------------------------------------------------------------------
		// 切替スライドのイベントを設定する
		function setSlideDivEvents(){
			$('#slideForward').click(function(){manageSlide(1);});
			$('#slideBackward').click(function(){manageSlide(-1);});
			$('#slideNowTantou').click(function(){fitMapBoundsFocusedMarkers();});
			$('#slideNowAddress').click(function(){manageSlide(0); myMap.setZoom(16);})
		}

		// スライドの表示IDを管理・反映
		function manageSlide(increment, setId){
			// 状態変数の初期化
			if (typeof manageSlide.id === 'undefined'){
				manageSlide.id = 0;
			}
			if (setId ){
				manageSlide.id = setId;
			}

			// focused担当者のデータ一覧を取得
			var newData = getFocusedTantouData();

			// 状態変数増減させる
			manageSlide.id += increment
			manageSlide.id = Math.max(manageSlide.id, 0);
			manageSlide.id = Math.min(manageSlide.id,  newData.length - 1);

			// データをスライド情報に反映させる
			applySlideData(newData[manageSlide.id]);

		}

		// データをスライド情報に反映させる
		function applySlideData(curRow){
			// slideNowAddressに表示させる
			$('#slideNowAddress').text( curRow['住所']);

			// slideNowTantouに情報を表示
			$('#slideNowTantou').empty();
			$('#slideNowTantou').append( //
				$('<span>')
					.css('background-color', getTantouCssColorText(curRow['担当者']))
					.text('__'));
			$('#slideNowTantou').append(
				curRow['担当者'] + '（' + curRow['訪問順'] + '）');

			// マップ座標の変更
			var result = GeoHandle.cacheResult[curRow['住所']];
			if ( !result || result.address == GeoHandle.TEXT_FAILED) return;
			myMap.setCenter(result.latlng);
		}

		// --------------------------------------------------------------------
		//  setswitchDiv
		// --------------------------------------------------------------------
		// 担当切替セレクトボックスを設置する
		function setswitchDiv(){
			// DOMの取得
			var $switchSelect = $('#switchSelect');

			// 一度中身を空にする
			$switchSelect.empty();

			// 担当者一覧でオプションを作成する
			myData.getList('担当者', true).forEach(function(tantou){
				$('<option>')
					.text(tantou)
					.appendTo($switchSelect);
			});

			// 担当者が変更された時のイベント
			$switchSelect.change(function(){
				// 担当者名を取得
				var tantou = $(this).find('option:selected').text();

				// 指定した担当スパンをフォーカス状態にする
				changeFocusedTantou(tantou)

			});

			// 強制的に変更イベントを起こす
			setTimeout(
				function(){
					$switchSelect.trigger('change');
				},1000);
		}

		// --------------------------------------------------------------------
		function getMyMapOption(){
			var mapCenter = {lat:35.5, lng:139.6};
			var	mapzoom = 14;
			return {
				center:mapCenter,
				zoom:mapzoom,
				mapTypeControl:false,
				streetViewControl:false,
				streetViewControlOptions:{
					position: google.maps.ControlPosition.RIGHT_TOP,
				},
				zoomControl:false,
				zoomControlOptions:{
					position: google.maps.ControlPosition.RIGHT_CENTER,
					style:google.maps.ZoomControlStyle.LARGE
				},
				scaleControl: true,
	  		scaleControlOptions: {
	    	position: google.maps.ControlPosition.BOTTOM_LEFT
	  		},
			};
		}

		// --------------------------------------------------------------------
		//  main
		// --------------------------------------------------------------------
		// トグルスイッチ
		$('#toggleDataBtn').click(toggleDataDiv);
		$('#toggleSearchBtn').click(toggleSearchDiv);
		$('#toggleTantouBtn').click(toggleTantouDiv);

		// 取り込みボタンのイベントを設定する
		setDataDivEvents();

		// 検索ボタンのイベントを設定する
		setSearchDivEvents();

		// 切替スライドのイベントを設定する
		setSlideDivEvents();

		// myData ObjectArrayオブジェクト用の変数を宣言する importData内で初期化されます
		var myData;

		// オプション用の変数を用意 デフォルトを設定 importData内で再設定できます
		var myTitle = 'かんたん地図プロット';
		var myGroupBy = '担当者';
		var mySortBy = '訪問順';
		var myPlotBy = '住所';

		// マーカー配列を用意
		var myMarkerArr = [];

		// マップの表示領域を格納する
		var myBounds = new google.maps.LatLngBounds();

		// googleマップの読込み
		var myMap = new google.maps.Map($('#map')[0], getMyMapOption());

		// URIに#以降があればそのパラメータでdataImportを行う
		if (location.hash.length >= 0){
			importData(decodeURI(location.hash.substring(1)),
			true, true ,true);// default true true
		}

		// geocoderキャッシュ管理オブジェクトを初期化
		GeoHandle.init();

	})();

</script>
</body>
</html>
