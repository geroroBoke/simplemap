<!DOCTYPE html>
<!--
やること
		ちょっと検索ダイアログでマーカー追加

		fixedサイドバー
			dipslay none <>
			fixedで表示を切り替え
			またはホーバーで広がるサイドバー

		仮マーカーの実装　
			あらかじめ各町のlatlngを取得しておく
			要外部DBへの接続実装
-->


<html lang="ja">
<head>
	<title>地図プロット</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width; initial-scale=1">
	<link rel="stylesheet" href="geoHandle.css" type="text/css">
	<script src="http://maps.google.com/maps/api/js?language=ja"></script>
	<script src="https://google-maps-utility-library-v3.googlecode.com/svn-history/r213/trunk/richmarker/src/richmarker-compiled.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="geoHandle.js"></script>
	<script src="./dataHandle.js"></script>
	<script src="../dataHandle/dataHandle.js"></script>
</head>
<body>
	<div id="side">
		<div id="toggle">
			<button id="toggleBtn" >データ取込</button>
		</div>
		<div id="tantouContainer">
		</div>
	</div>
	<div id="main">
		<div id="middle">
			<div id="map"></div>
		</div>
	</div>
	<!-- サーチボックス -->
	<div id="searchDiv">
		<input type="textbox" id = "searchText" value="" size="40"><button id="searchButton">検索する</button>
	</div>
	<!-- データ取込フォーム -->
	<div id="dataDiv">
		<div id="dataClose" class="clickable">×</div>
		<span id="dataTitle">住所データを「タブ区切りのレコード」で入力</span>
		<p><textarea id="dataText" cols="90" rows="14"></textarea></p>
		<button id="dataBtnImport" >プロット開始</button>
		<input type="checkbox" id="dataChkTrim" checked="true"><label for="dataChkTrim">ゴミ文字を削除</label>
		<input type="checkbox" id="dataChkMansion" checked="true"><label for="dataChkMansion">マンション名削除</label>
	</div>
	<!-- 住所切替スライド -->
	<div id="slideDiv">
		<span id="slideBackward" class="clickable">←←</span>
		<span id="slideNowContent"> 現在表示中の住所名 </span>
		<span id="slideForward" class="clickable">→→</span>
	</div>

<script>
// -----------------------------------------------------------
	(function(){
		'use strict'
		// --------------------------------------------------------------------
		//  trivial functions
		// --------------------------------------------------------------------
		// 担当者の名前から色を選出する
		function getTantouCssColorText(tantouName){
			var tantouArr =kData.getList('担当者', true);
			var index = tantouArr.indexOf(tantouName);
			var length = tantouArr.length;
			return 'hsla(' +(300/length*index)  + ' , ' + (35+((index%2)*25))+ '%, 50%, 1)'
		}
		//文字列からスペースと”。”を取り除く
		function trimGarbage(str){
				if (typeof str != 'string') return; //throw new Error('string型を引数にいれてください');
				str = str.replace(/[ 　]/g, "");
				str = str.replace(/。/g, "");
				return str;
		}
		// 住所文字列からマンション名（と思われるもの）以降を取り除く
		// 数字より後ろの文字はマンション名と判断する
		function trimMansionOrlater(str){
			// 文字列でない場合は終了
			if (typeof str != 'string') return;
			// 数字と区切り文字の定義
			var arrNumber = '0123456789０１２３４５６７８９';
			var arrDelimiter = '[ 　-ーー〜~−ｰー‐－の丁目]';
			// 実行する
			var flgNumber = false; // 数字がすでに出現している
			for(var i = 0 ; i < str.length ; i++){
				var c = str.charAt(i);
				if (!flgNumber ){
					flgNumber = (arrNumber.indexOf(c) != -1 );
				} else {
					// 数字でもなく、区切り文字でもない
					if (arrNumber.indexOf(c) == -1 && arrDelimiter.indexOf(c) == -1  )
					break;
				}
			}
			return str.substr(0, i);
		}

		// --------------------------------------------------------------------
		//  setTantouContainer
		// --------------------------------------------------------------------
		// 担当者ボックスを初期化する
		function setTantouContainer(){

			// エレメントの取得
			var $tantouContainer = $('#tantouContainer');

			// 中の要素を削除する
			$tantouContainer.empty();

			// 各担当者のボタンを作成する
			kData.getList('担当者', true).forEach(function(element){
				var $tantouSpan = createTantouSpan(element);
				$tantouSpan.click(event_TantouSpanClick);
				$tantouContainer.append($tantouSpan);
			});

			// すべて表示ボタンを作成する
			var $selallSpan = createTantouSpan('すべて表示');
			$selallSpan.click(event_SelallSpanClick);
			$tantouContainer.append($selallSpan);
		}

		// 担当者の名前一覧のspanをつくる
		function createTantouSpan(tantouName){
			var $span = $('<span>').attr({id: tantouName, class: 'tantou'});
			$span.append($('<span>').css('background-color', getTantouCssColorText(tantouName)).text('__'));
			$span.append(tantouName);
			return $span;
		}

		// 担当者スパンに特定のクラスが付いているか判別する
		function isTantouClassed(tantou, classname){
			if (typeof tantou !== 'string') return false;
			return $('#' + tantou.replace(':', '\\:')).hasClass(classname);
		}
		
		// --------------------------------------------------------------------
		// event_SelallSpanClick
		// --------------------------------------------------------------------
		// すべてを表示ボタンがクリックされた時
		function event_SelallSpanClick(event){

			// 他のスパンのfocusedを消す
			$(this).siblings().removeClass('focused');

			// すべて表示ボタンの選択状態をトグル
			$(this).toggleClass('marked');

			// 他の要素もすべて表示ボタンに倣う
			if ($(this).hasClass('marked')){ $(this).siblings().addClass('marked');
			}else {$(this).siblings().removeClass('marked');}

			// 表示領域情報をを現在の表示と一致させる
			myBounds = map.getBounds();

			// マーカーをリフレッシュする
			refleshMarker();
		}
		// --------------------------------------------------------------------
		// event_TantouSpanClick
		// --------------------------------------------------------------------
		// TantouSpanがクリックされた時 markedクラスを付加する
		function event_TantouSpanClick(event){
		
			// 現在のクラス情報をフラグとして取得
			var flgMarked = $(this).hasClass('marked');
			var flgFocused = $(this).hasClass('focused');
			var flgOtherFocused = $(this).siblings().hasClass('focused');
			
			// フラグに応じてクラスを遷移する
			if (!flgMarked && !flgFocused){
				// nomark > marked
				$(this).addClass('marked');
			}
			//else if (flgMarked && flgOtherFocused){
			//	// marked and other focused > do nothing
			//}
			else if (flgMarked && !flgFocused) {
				// marked > focused
				$(this).addClass('focused');
			}
			else if (flgMarked && flgFocused) {
				// focused > nomark	
				$(this).removeClass('focused');
				$(this).removeClass('marked');
			}

			// 他のスパンのfocusedクラスを消す
			$(this).siblings().removeClass('focused');

			
			// 該当担当者の住所リストを優先キューに入れる
			if ($(this).hasClass('marked') ) GeoHandle.addAddress(kData.getList('住所', true, '担当者', $(this).attr('id')), true);
			
			// フォーカスされていたら表示領域をリセットする
			if ($(this).hasClass('focused') ) myBounds = null;

			// マーカーをリフレッシュする
			refleshMarker();
		};
		// --------------------------------------------------------------------
		//  createMarker
		// --------------------------------------------------------------------
		// GeoHandleのchacheResultに基づいてマーカーを作成する
		function createMarker(id, result, dataRow){

			// richMarkerのプロパティ
			var latlng = result.latlng;
			var labelText = dataRow['担当者'].match(/[^\d:;#]/) + dataRow['訪問順']; // 吹き出しの中身 	// 数字や記号以外で最初の一文字を取得する
			var colorText = getTantouCssColorText(dataRow['担当者']);// 吹き出しの色を取得
			var commentText = result.address; // 横のコメントの内容

			// richMarkerを作成
			var marker = createRichMarker(id, latlng, labelText, colorText, commentText);

			// クリック時にInfoWindowを作成
			marker.addListener('click', function(e){
				var info = createInfoWindow(dataRow);
				info.open(map, marker);
			});

			// 作成したマーカーを返す
			return marker;

		}

		// 与えられたプロパティでrichMarkerをつくる
		function createRichMarker(id, latlng, labelText, colorText, commentText){

			// richmarkerのcontentの作成
			var $contentDiv = $('<div>')
				.attr('id', id)
				.append(
					$('<div>')
						.attr('class', 'marker')
						.css({'background-color' : colorText,'border-top-color':  colorText})
						.text(labelText)
					,$('<div>')
						.attr('class', 'markerComment')
						.text(commentText)
				);

			// マーカーの作成
			var marker = new RichMarker({
				position: latlng,
				map: map,
				flat: true,		//true推奨
				content: $contentDiv[0].outerHTML,
			});

			// マーカーを設置する
			return marker;
		}

		// InfoWindowを作成
		function createInfoWindow(dataRow){
			// 中身の作成
			var content ='';
			Object.keys(dataRow).forEach(function(k){
				content += k + ':' + dataRow[k] + '<br>';
			});

			// infowindowの作成
			var info = new google.maps.InfoWindow({
				maxWidth:250,
				pixelOffset:{height:-15, width:0},
				content:content,
			});
			// InfoWindowを返す
			return info;
		}

		// --------------------------------------------------------------------
		//  refleshMarker
		// --------------------------------------------------------------------
		// マーカーを再描画する
		function refleshMarker(){
		
			//	データの担当者一つ一つに対して
			kData.data.forEach(function(dataRow, id){
			
				// switch(marked)
				if (!isTantouClassed(dataRow['担当者'], 'marked')){
				
					// OFFマーカーの削除
					if(markerArr[id]) markerArr[id].setMap(null);
					markerArr[id] = null;
					
				}else {
					// ON
					// キャッシュからジオコーダ結果を取得
					var result = GeoHandle.cacheResult[dataRow['住所']];
					
					//ジオコーダ未取得もしくは取得失敗なら終了
					if (!result) return;
					if (result.address == GeoHandle.TEXT_FAILED) return;

					// マーカーが未作成なら作成
					if (markerArr[id] == null) markerArr[id] = createMarker(id, result, dataRow); // マーカーを作成
				}
				
				// focused 
				if (isTantouClassed(dataRow['担当者'], 'focused')){
					if (markerArr[id] ){
					
						// マップの表示領域を拡大する
						mymapExpandBounds(markerArr[id]);
						
						// マーカーのコメント部分にfocusedクラスを付加する
						$('#'+id + '>.markerComment').addClass('markerFocused');
					} 
				}else{
					if (markerArr[id] ){
						// マーカーのコメント部分からfocusedクラスを除く
						$('#'+id + '>.markerComment').removeClass('markerFocused');
					}
				}
			});
		}

		// 指定マーカーに合わせてマップの表示領域を拡大する
		function mymapExpandBounds(marker){
			//var curBounds = myBounds;
			if (!myBounds) myBounds = new google.maps.LatLngBounds();
			if (!myBounds.contains(marker.getPosition())){
				myBounds.extend(marker.getPosition());
				map.fitBounds(myBounds);
			}
		}

		// --------------------------------------------------------------------
		//  importData
		// --------------------------------------------------------------------
		// 渡されたテキストをパースして地図プロットする
		function importData(dataText, isTrimGarbage, isTrimMansion){

			// テキストが空なら終了
			if (!dataText) return;

			// テキストをパースする
			var data = dataHandle.csvParse(dataText, '\t', true);

			// 正しいフィールドを持っているか確認
			if (!data) return;
			if (!data.getList('住所')) return;
			if (!data.getList('担当者')) return;
			if (!data.getList('訪問順')) return;

			// フィールド名と等しい値がある行は削除する
			data.data = data.data.filter(function(row){
				if (row['住所'] ==='住所') return false;
				if (row['担当者']==='担当者') return false;
				if (row['訪問順']==='訪問順') return false;
				return true;
			});

			// Trimフラグがあれば行う
			if (isTrimGarbage){data.data.forEach(function(row){row['住所'] = trimGarbage(row['住所']);});}
			if (isTrimMansion){data.data.forEach(function(row){row['住所'] = trimMansionOrlater(trimGarbage(row['住所']));});}

			// dataをプロット用のデータとして採用する
			kData = data;

			// 新しいデータでマップの初期化をしなおす
			init();
		}

		// --------------------------------------------------------------------
		//  init
		// --------------------------------------------------------------------
		// 担当者ボックスを初期化する、マーカーを初期化する
		function init(){
			// データがなければ終了
			if (!kData) return;

			// 担当者ボックスの初期化
			setTantouContainer();

			// 全マーカの削除
			for (var i = 0; i < markerArr.length ; i++){
				if (markerArr[i]) markerArr[i].setMap(null);
			}
			markerArr = [];

			// 地図の表示範囲初期化
			myBounds = null;

			// GeoHandleオブジェクトの操作
			GeoHandle.onLocate = myCallBack; //マーカーの再描画
			GeoHandle.addAddress(kData.getList('住所', true));
			GeoHandle.doNextSearch();
		}

		// アイテムが取得される度に呼ばれる(geocoderResult)
		function myCallBack(request, result){
			refleshMarker();
		}

		// --------------------------------------------------------------------
		//  dataDiv
		// --------------------------------------------------------------------
		// データ取込フォーム dataDiv関連のイベントを設定する
		function setDataDivEvents(){
			$('#dataBtnImport').click(function(){
				toggleDataDiv();
				importData($('#dataText').val(), $('#dataChkTrim').prop('checked'), $('dataChkMansion').prop('checked'));
			});
			$('#toggleBtn').click(toggleDataDiv);
			$('#dataClose').click(toggleDataDiv)
		}
		// dataDivの表示・非表示を切り返す
		function toggleDataDiv(){
			// DOMの取得
			var $dataDiv = $('#dataDiv');
			var $dataText = $('#dataText');

			// 表示・非表示を切り替える
			$dataDiv.toggle();

			// 表示ＯＮならテキストにフォーカス等の操作をする
			if($dataDiv.is(':visible')){
				setTimeout(function(){
					// 現在のデータをCSVにして再表示
					if (kData) $dataText.text(dataHandle.csvOutput(kData.data, '\t'));
					$dataText.focus();
					$dataText.append('');
				}, 1);
			}
		}		
		// --------------------------------------------------------------------
		//  searchDiv
		// --------------------------------------------------------------------
		// サーチボックス 検索場所に新しくマーカーを立てる
		function setSearchDivEvents(){
			$('#searchButton').click(function(){
				var addData = {};
				addData['担当者'] = '他';
				addData['訪問順'] = '';
				addData['住所'] = $('#searchText').val();
				if (!kData){
					kData = new dataHandle.ObjectArray([ addData]);
				}else{
					kData.data.push(addData);
				}
				// マップを初期化し直す
				// TODO イニットではなくリフレッシュ的なやつを考える
				init();
			});
		}
		
		// --------------------------------------------------------------------
		// slideDiv
		// --------------------------------------------------------------------
		// 切替スライドのイベントを設定する
		function setSlideDivEvents(){
			$('#slideForward').click(function(){manageSlide(1);});
			$('#slideBackward').click(function(){manageSlide(-1);});
			
			// inner function
			// スライドの表示IDを管理・反映
			function manageSlide(increment){
				// データがなければ終了
				if (!kData) return;

				// 状態変数の初期化
				if (typeof manageSlide.selectId === 'undefined'){
					manageSlide.selectId = 0;
				
				// focusedになっている担当スパンを取得
				var focused = kData.getList('担当者', true).filter(function(tantou){
					return isTantouClassed(tantou, 'focused');
				});
				
				// focused担当者の住所一覧を訪問順で取得
				var addressArr = kData.getList('住所', true, '担当者', focused, '訪問順', true)

				}
				// 状態変数増減させる
				manageSlide.selectId += increment;
				if (manageSlide.selectId < 0)  manageSlide.selectId = 0;
				if (manageSlide.selectId > addressArr.length) manageSlide.selectId = addressArr.length;
				
				// slideNowContentに表示させる
				if (focused){$('#slideNowContent').text(addressArr[manageSlide.selectId]);}
			}
		}

		// --------------------------------------------------------------------
		//  main
		// --------------------------------------------------------------------
		// 取り込みボタンのイベントを設定する
		setDataDivEvents();

		// 検索ボタンのイベントを設定する
		setSearchDivEvents();
		
		// 切替スライドのイベントを設定する
		setSlideDivEvents();

		// data ObjectArray オブジェクト dataImportないで初期化される
		var kData;

		// マーカー配列を用意
		var markerArr = [];

		// マップの表示領域を格納する
		var myBounds = new google.maps.LatLngBounds();

		// googleマップの読込み
		var mapCenter = {lat:35.5, lng:139.6};
		var	mapzoom = 14;
		var map = new google.maps.Map($('#map')[0], {center:mapCenter,zoom:mapzoom});

		// geocoderキャッシュ管理オブジェクトを初期化
		GeoHandle.init();

		// 呼出パラメータでマップを生成する
		if (location.hash.length >= 0){
			importData(decodeURI(location.hash.substring(1)));
		}
	})();

</script>
</body>
</html>
